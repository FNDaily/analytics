{% extends "_layouts/cp" %}
{% import "_includes/forms" as forms %}

{% set title = "Analytics"|t %}
{% set provider = 'Google' %}

{% includeCssResource "analytics/css/styles.css" %}

{%- includeJsResource 'analytics/js/jsapi.js' first %}

{% includeJsResource 'analytics/js/dchart.js' %}
{% includeJsResource 'analytics/js/dukt-chart.js' %}





{% set extraPageHeaderHtml %}
  <a class="btn settings icon" href="{{ url('analytics/settings') }}" title="{{ 'Settings'|t }}"></a>
{% endset %}

{% set content %}

    {#% set account = craft.oauth.getAccount('analytics.system', provider) %#}

    {% set accountId = false %}
    {% set webPropertyId = false %}

    {% set properties = craft.analytics.api.management_webproperties.listManagementWebproperties("~all") %}

    {% for item in properties.items %}
      {% if item.id ==  craft.analytics.getSetting('profileId') %}

        {% set accountId = item.accountId %}
        {% set webPropertyId = item.id %}

      {% endif %}
    {% endfor %}


    {% set profiles = craft.analytics.api.management_profiles.listManagementProfiles(accountId, webPropertyId) %}
    {% set profileId = profiles.items[0].id %}



    <h2 class="center">Last 30 days</h2>

    {% include 'analytics/_chart2' with {
        chart: {
            options: {
                id:'visits',
                half: false,
            },
            chartQuery: {
                param1 : 'ga:' ~ profileId,
                param2 : now|date_modify("-1 month")|date("Y-m-d"),
                param3 : now|date("Y-m-d"),
                param4 : 'ga:visits',
                param5 : {
                    'dimensions' : 'ga:year, ga:month, ga:day'
                }
            },
            chartOptions: {
                title: 'Visits',
                chartType:'line'

            }
        }
    } %}

    {% include 'analytics/_chart2' with {
        chart: {
            options: {
                id:'countries',
                half: true,
            },
            chartQuery: {
                param1 : 'ga:' ~ profileId,
                param2 : now|date_modify("-1 month")|date("Y-m-d"),
                param3 : now|date("Y-m-d"),
                param4 : 'ga:visits',
                param5 : {
                    'dimensions' : 'ga:country'
                }
            },
            chartOptions: {
                title: 'Countries',
                chartType:'donut'
            }
        }
    } %}


    <div class="charts">

        {% include 'analytics/_chart' with {
            id:'countries',
            options: {
                title: 'Countries',
                chartType:'donut'
            },
            half: true,
            sourceParams: {
                'dimensions' : 'ga:country'
            }
        } %}

        {% include 'analytics/_chart' with {
            id:'isMobile',
            options: {
                title: 'Is Mobile',
                chartType:'donut'
            },
            half: true,
            sourceParams: {
                'dimensions' : 'ga:isMobile'
            }
        } %}

        {% include 'analytics/_chart' with {
            id:'socialNetworks',
            options: {
                title: 'Social Networks',
                chartType:'donut'
            },
            half: true,
            sourceParams: {
                'dimensions' : 'ga:socialNetwork'
            }
        } %}


        {% include 'analytics/_chart' with {
            id:'sources',
            options: {
                title: 'Sources',
                chartType:'donut'
            },
            half: true,
            sourceParams: {
                'dimensions' : 'ga:source'
            }
        } %}

      <div class="clear"></div>
    </div>

{% endset %}
