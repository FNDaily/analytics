var Analytics={},googleVisualisationCalled=!1;Analytics.Stats=Garnish.Base.extend({data:{period:"week"},init:function(t,e){this.$element=$("#"+t),this.$body=$(".body",this.$element),this.$spinner=$(".spinner",this.$element),this.$settingsBtn=$(".dk-settings-btn",this.$element),this.chartRequest=e.cachedRequest,this.chartResponse=e.cachedResponse,this.addListener(this.$settingsBtn,"click","openSettings"),this.initGoogleVisualization($.proxy(function(){this.handleChartResponse("area",this.chartResponse)},this))},initGoogleVisualization:function(t){0==googleVisualisationCalled&&("undefined"==typeof AnalyticsChartLanguage&&(AnalyticsChartLanguage="en"),google.load("visualization","1",{packages:["corechart","table","geochart"],language:AnalyticsChartLanguage}),googleVisualisationCalled=!0),google.setOnLoadCallback($.proxy(function(){"undefined"!=typeof google.visualization&&t()},this))},openSettings:function(t){this.settingsModal?this.settingsModal.show():($form=$('<form class="settingsmodal modal fitted"></form>').appendTo(Garnish.$bod),$body=$('<div class="body"/>').appendTo($form),$footer=$('<div class="footer"/>').appendTo($form),$buttons=$('<div class="buttons right"/>').appendTo($footer),$cancelBtn=$('<div class="btn">'+Craft.t("Cancel")+"</div>").appendTo($buttons),$saveBtn=$('<input type="submit" class="btn submit" value="'+Craft.t("Save")+'" />').appendTo($buttons),this.settingsModal=new Garnish.Modal($form,{visible:!1,resizable:!1}),this.addListener($cancelBtn,"click",function(){this.settingsModal.hide()}),this.addListener($form,"submit",$.proxy(function(t){t.preventDefault();var e=$("input, textarea, select",$form).filter(":visible").serialize(),a=$.parseParams(e);this.chartResponse=this.sendRequest(a),this.settingsModal.hide()},this)),Craft.postActionRequest("analytics/settingsModal",{},$.proxy(function(t,e){$(".body",this.settingsModal.$container).html(t.html),Craft.initUiElements()},this)))},sendRequest:function(t){this.$spinner.removeClass("hidden"),$(".chart",this.$body).remove(),Craft.postActionRequest("analytics/stats/getChart",t,$.proxy(function(e,a){this.$spinner.addClass("hidden"),this.handleChartResponse(t.chart,e)},this))},handleChartResponse:function(t,e){switch(t){case"area":this.handleAreaChartResponse(e);break;case"counter":this.handleCounterResponse(e);break;case"geo":this.handleGeoResponse(e);break;case"pie":this.handlePieResponse(e);break;case"table":this.handleTableResponse(e);break;default:console.error('Chart type "'+t+'" not supported.')}},handleGeoResponse:function(t){$chart=$('<div class="chart geo" />'),$chart.appendTo(this.$body),this.chartDataTable=Analytics.Utils.responseToDataTable(t.table),this.chartOptions=Analytics.ChartOptions.geo(this.data.dimensions),this.chart=new google.visualization.GeoChart($chart.get(0)),this.chart.draw(this.chartDataTable,this.chartOptions)},handleTableResponse:function(t){$chart=$('<div class="chart table" />'),$chart.appendTo(this.$body),this.chartDataTable=Analytics.Utils.responseToDataTable(t.table),this.chartOptions=Analytics.ChartOptions.table(),this.chart=new google.visualization.Table($chart.get(0)),this.chart.draw(this.chartDataTable,this.chartOptions)},handlePieResponse:function(t){$chart=$('<div class="chart pie" />'),$chart.appendTo(this.$body),this.chartDataTable=Analytics.Utils.responseToDataTable(t.table),this.chartOptions=Analytics.ChartOptions.pie(),this.chart=new google.visualization.PieChart($chart.get(0)),this.chart.draw(this.chartDataTable,this.chartOptions)},handleAreaChartResponse:function(t){if($chart=$('<div class="chart area" />'),$chart.appendTo(this.$body),this.chartDataTable=Analytics.Utils.responseToDataTable(t.area),this.chartOptions=Analytics.ChartOptions.area(t.period),"year"==t.period){var e=new google.visualization.DateFormat({pattern:"MMMM yyyy"});e.format(this.chartDataTable,0)}this.chart=new google.visualization.AreaChart($chart.get(0)),this.chart.draw(this.chartDataTable,this.chartOptions)},handleCounterResponse:function(t){$chart=$('<div class="chart counter" />').appendTo(this.$body),$value=$('<div class="value" />').appendTo($chart),$label=$('<div class="label" />').appendTo($chart),$period=$('<div class="period" />').appendTo($chart),$value.html(t.counter.count),$label.html(t.metric),$period.html(t.period)}}),Analytics.Utils={responseToDataTable:function(response){var data=new google.visualization.DataTable;return $.each(response.cols,function(t,e){data.addColumn(e)}),console.log("response",response),$.each(response.rows,function(kRow,row){$.each(row,function(kCell,cell){switch(response.cols[kCell].type){case"date":$dateString=cell.v,8==$dateString.length?($year=eval($dateString.substr(0,4)),$month=eval($dateString.substr(4,2))-1,$day=eval($dateString.substr(6,2)),$date=new Date($year,$month,$day),row[kCell]=$date):6==$dateString.length&&($year=eval($dateString.substr(0,4)),$month=eval($dateString.substr(4,2))-1,$date=new Date($year,$month,"01"),row[kCell]=$date)}}),data.addRow(row)}),data}},Analytics.ChartOptions=Garnish.Base.extend({},{area:function(t){switch(options=this.defaults.area,t){case"week":options.hAxis.format="E",options.hAxis.showTextEvery=1;break;case"month":options.hAxis.format="MMM d",options.hAxis.showTextEvery=1;break;case"year":options.hAxis.showTextEvery=1,options.hAxis.format="MMM yy"}return options},table:function(){return this.defaults.table},geo:function(t){switch(options=this.defaults.geo,t){case"ga:city":options.displayMode="markers";break;case"ga:country":options.resolution="countries",options.displayMode="regions";break;case"ga:continent":options.resolution="continents",options.displayMode="regions";break;case"ga:subContinent":options.resolution="subcontinents",options.displayMode="regions"}return options},pie:function(){return this.defaults.pie},field:function(){return{colors:["#058DC7"],backgroundColor:"#fdfdfd",areaOpacity:.1,pointSize:8,lineWidth:4,legend:!1,hAxis:{textStyle:{color:"#888"},baselineColor:"#fdfdfd",gridlines:{color:"none"}},vAxis:{maxValue:5},series:{0:{targetAxisIndex:0},1:{targetAxisIndex:1}},vAxes:[{textStyle:{color:"#888"},format:"#",textPosition:"in",baselineColor:"#eee",gridlines:{color:"#eee"}},{textStyle:{color:"#888"},format:"#",textPosition:"in",baselineColor:"#eee",gridlines:{color:"#eee"}}],chartArea:{top:10,bottom:10,width:"100%",height:"80%"}}},defaults:{area:{theme:"maximized",legend:"none",backgroundColor:"#FFF",colors:["#058DC7"],areaOpacity:.1,pointSize:8,lineWidth:4,chartArea:{},hAxis:{format:"E",textPosition:"in",textStyle:{color:"#058DC7"},showTextEvery:1,baselineColor:"#fff",gridlines:{color:"none"}},vAxis:{textPosition:"in",textStyle:{color:"#058DC7"},baselineColor:"#ccc",gridlines:{color:"#fafafa"},maxValue:0}},geo:{displayMode:"auto"},pie:{theme:"maximized",height:282,pieHole:.5,legend:{alignment:"center",position:"top"},chartArea:{top:40,height:"82%"},sliceVisibilityThreshold:1/120},table:{}}}),function(t){var e=/([^&=]+)=?([^&]*)/g,a=/\+/g,s=function(t){return decodeURIComponent(t.replace(a," "))};t.parseParams=function(t){for(var a,i={};a=e.exec(t);){var o=s(a[1]),n=s(a[2]);"[]"===o.substring(o.length-2)?(o=o.substring(0,o.length-2),(i[o]||(i[o]=[])).push(n)):i[o]=n}return i}}(jQuery);