var googleVisualisationCalled=!1;Analytics.Stats=Garnish.Base.extend({requestData:null,init:function(t,e){console.log("Analytics.Stats(element, options)"),console.log("---- element",t),console.log("---- options",e),this.$element=$("#"+t),this.$title=$(".title",this.$element),this.$body=$(".body",this.$element),this.$date=$(".date",this.$element),this.$spinner=$(".spinner",this.$element),this.$settingsBtn=$(".dk-settings-btn",this.$element),this.chartRequest=e.cachedRequest,this.chartResponse=e.cachedResponse,"undefined"!=typeof this.chartRequest&&(this.requestData=this.chartRequest),this.addListener(this.$settingsBtn,"click","openSettings"),this.initGoogleVisualization($.proxy(function(){this.chartResponse&&(this.$spinner.addClass("hidden"),this.handleChartResponse(this.requestData.chart,this.chartResponse))},this))},initGoogleVisualization:function(t){0==googleVisualisationCalled&&("undefined"==typeof AnalyticsChartLanguage&&(AnalyticsChartLanguage="en"),google.load("visualization","1",{packages:["corechart","table","geochart"],language:AnalyticsChartLanguage}),googleVisualisationCalled=!0),google.setOnLoadCallback($.proxy(function(){"undefined"!=typeof google.visualization&&t()},this))},periodChange:function(t){console.log("Analytics.Stats.periodChange()"),this.requestData&&(this.requestData.period=$(t.currentTarget).val(),this.chartResponse=this.sendRequest(this.requestData))},openSettings:function(t){this.settingsModal?this.settingsModal.show():($form=$('<form class="settingsmodal modal fitted"></form>').appendTo(Garnish.$bod),$body=$('<div class="body"/>').appendTo($form),$footer=$('<div class="footer"/>').appendTo($form),$buttons=$('<div class="buttons right"/>').appendTo($footer),$cancelBtn=$('<div class="btn">'+Craft.t("Cancel")+"</div>").appendTo($buttons),$saveBtn=$('<input type="submit" class="btn submit" value="'+Craft.t("Save")+'" />').appendTo($buttons),this.settingsModal=new Garnish.Modal($form,{visible:!1,resizable:!1}),this.addListener($cancelBtn,"click",function(){this.settingsModal.hide()}),this.addListener($form,"submit",$.proxy(function(t){t.preventDefault();var e=$("input, textarea, select",$form).filter(":visible").serializeJSON();this.requestData=e,console.log("parsedParams",this.requestData),this.chartResponse=this.sendRequest(this.requestData),this.settingsModal.hide(),this.saveState()},this)),Craft.postActionRequest("analytics/settingsModal",{id:this.$element.data("id")},$.proxy(function(t,e){$(".body",this.settingsModal.$container).html(t.html),this.$periodSelect=$(".period select",this.settingsModal.$container),this.$chartSelect=$(".chart-select select",this.settingsModal.$container),this.requestData&&(this.$chartSelect.val(this.requestData.chart),this.$chartSelect.trigger("change"),this.$periodSelect.val(this.requestData.period),this.$periodSelect.trigger("change")),Craft.initUiElements()},this)))},saveState:function(){console.log("Analytics.Stats().saveState()");var t={id:this.$element.data("id"),settings:{colspan:this.requestData.colspan,chart:this.requestData.chart,period:this.requestData.period,options:this.requestData.options}};console.log("Save state data",t),Craft.queueActionRequest("analytics/saveWidgetState",t,$.proxy(function(t){},this))},sendRequest:function(t){this.$spinner.removeClass("hidden"),$(".chart",this.$body).remove(),console.log("Analytics.Stats().sendRequest(data)"),console.log("---- data",t),Craft.postActionRequest("analytics/stats/getChart",t,$.proxy(function(e,a){this.$spinner.addClass("hidden"),this.handleChartResponse(t.chart,e)},this))},handleChartResponse:function(t,e){switch(t){case"area":this.handleAreaChartResponse(e);break;case"counter":this.handleCounterResponse(e);break;case"geo":this.handleGeoResponse(e);break;case"pie":this.handlePieResponse(e);break;case"table":this.handleTableResponse(e);break;default:console.error('Chart type "'+t+'" not supported.')}},handleGeoResponse:function(t){$chart=$('<div class="chart geo" />'),$chart.appendTo(this.$body),this.chartDataTable=Analytics.Utils.responseToDataTable(t.table),this.chartOptions=Analytics.ChartOptions.geo(this.requestData.dimensions),this.chart=new google.visualization.GeoChart($chart.get(0)),this.chart.draw(this.chartDataTable,this.chartOptions)},handleTableResponse:function(t){$chart=$('<div class="chart table" />'),$chart.appendTo(this.$body),this.chartDataTable=Analytics.Utils.responseToDataTable(t.table),this.chartOptions=Analytics.ChartOptions.table(),this.chart=new google.visualization.Table($chart.get(0)),this.chart.draw(this.chartDataTable,this.chartOptions)},handlePieResponse:function(t){$chart=$('<div class="chart pie" />'),$chart.appendTo(this.$body),this.chartDataTable=Analytics.Utils.responseToDataTable(t.chart),this.chartOptions=Analytics.ChartOptions.pie(),this.chart=new google.visualization.PieChart($chart.get(0)),this.chart.draw(this.chartDataTable,this.chartOptions)},handleAreaChartResponse:function(t){if($chart=$('<div class="chart area" />'),$chart.appendTo(this.$body),this.chartDataTable=Analytics.Utils.responseToDataTable(t.area),this.chartOptions=Analytics.ChartOptions.area(t.period),"year"==t.period){var e=new google.visualization.DateFormat({pattern:"MMMM yyyy"});e.format(this.chartDataTable,0)}this.chart=new google.visualization.AreaChart($chart.get(0)),this.chart.draw(this.chartDataTable,this.chartOptions),this.$title.html(t.metric),this.$date.html(t.periodLabel)},handleCounterResponse:function(t){$chart=$('<div class="chart counter" />').appendTo(this.$body),$value=$('<div class="value" />').appendTo($chart),$label=$('<div class="label" />').appendTo($chart),$period=$('<div class="period" />').appendTo($chart),$value.html(t.counter.count),$label.html(t.metric),$period.html(t.period)}});