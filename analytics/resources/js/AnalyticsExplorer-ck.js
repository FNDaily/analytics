(function(e){google.load("visualization","1",{packages:["corechart","table","geochart"]});AnalyticsExplorer=Garnish.Base.extend({init:function(t,n){console.log("settings",n);this.timer=!1;this.requestData=!1;this.currentMenu="audienceOverview";this.currentChart="table";this.currentPeriod="month";this.pinned=0;this.chartArea=!1;this.chartTable=!1;this.chartPie=!1;this.tableData=!1;this.chartAreaData=!1;this.$element=e("#"+t);this.$menu=e(".analytics-menu:first select:first",this.$element);this.$widget=e(".analytics-widget:first",this.$element);this.$chart=e(".analytics-chart",this.$element);this.$pie=e(".analytics-piechart",this.$element);this.$table=e(".analytics-table",this.$element);this.$dimensionField=e(".analytics-dimension-field",this.$element);this.$dimension=e(".analytics-dimension select",this.$element);this.$metric=e(".analytics-metric select",this.$element);this.$total=e(".analytics-total",this.$element);this.$totalCount=e(".analytics-count",this.$total);this.$totalLabel=e(".analytics-label",this.$total);this.$tableType=e(".analytics-tabletype:first",this.$element);this.$disabledTableType=e(".analytics-disabled-tabletype:first",this.$element);this.$tableTypeBtns=e(".analytics-tabletype .btn",this.$element);this.$period=e(".analytics-period",this.$element);this.$periodSelect=e(".analytics-period select",this.$element);this.$spinner=e(".spinner",this.$element);this.$pin=e(".analytics-pin",this.$element);this.$infosDimension=e(".analytics-infos-dimension",this.$element);this.$infosMetric=e(".analytics-infos-metric",this.$element);this.$infosCount=e(".analytics-infos-count",this.$element);this.$counter=e(".analytics-counter",this.$element);this.$counterValue=e(".analytics-counter-value",this.$element);this.$counterLabel=e(".analytics-counter-label",this.$element);this.$collapsible=e(".analytics-collapsible",this.$element);this.addListener(this.$menu,"change","onMenuChange");this.addListener(this.$tableTypeBtns,"click","onTableTypeChange");this.addListener(this.$periodSelect,"change","onPeriodChange");this.addListener(this.$pin,"click","onPin");this.addListener(this.$dimension,"change","onChangeDimension");this.addListener(this.$metric,"change","onChangeMetric");this.addListener(Garnish.$win,"resize","resize");this.applySettings(n);this.$spinner.removeClass("body-loading");this.$periodSelect.val(this.currentPeriod);if(this.pinned){this.$pin.addClass("active");this.$collapsible.animate({opacity:0,height:"toggle"},0)}this.$menu.val(this.currentMenu);this.changeMenu(this.currentMenu);this.changeTableType(this.currentChart);this.$dimension.val(this.currentDimension);this.$metric.val(this.currentMetric);this.$period.val(this.currentPeriod);this.browse()},onChangeDimension:function(t){this.currentDimension=e(t.currentTarget).val();this.saveState();this.browse()},onChangeMetric:function(t){this.currentMetric=e(t.currentTarget).val();this.saveState();this.browse()},applySettings:function(e){typeof e.menu!="undefined"&&(this.currentMenu=e.menu);typeof e.dimension!="undefined"&&(this.currentDimension=e.dimension);typeof e.metric!="undefined"&&(this.currentMetric=e.metric);typeof e.chart!="undefined"&&(this.currentChart=e.chart);typeof e.period!="undefined"&&(this.currentPeriod=e.period);typeof e.pinned!="undefined"&&(this.pinned=e.pinned)},setSection:function(t){var n=!1;e.each(AnalyticsBrowserData,e.proxy(function(e,r){e==t&&(n=r)},this));this.sectionDimensions=!1;this.sectionMetrics=!1;this.sectionEnabledCharts=!1;this.sectionRealtime=!1;this.sectionChart=!1;if(n){typeof n.dimensions!="undefined"&&(this.sectionDimensions=n.dimensions);typeof n.metrics!="undefined"&&(this.sectionMetrics=n.metrics);typeof n.enabledCharts!="undefined"&&(this.sectionEnabledCharts=n.enabledCharts);typeof n.realtime!="undefined"&&(this.sectionRealtime=n.realtime);typeof n.chart!="undefined"&&(this.sectionChart=n.chart)}},browse:function(){var e={id:this.$widget.data("widget-id"),metric:this.$metric.val(),period:this.$periodSelect.val(),realtime:0};this.$dimensionField.hasClass("hidden")||(e.dimension=this.$dimension.val());this.sectionRealtime&&(e.realtime=1);this.requestData=e;this.request(e)},request:function(t){console.log("request",t);this.$spinner.removeClass("hidden");Craft.postActionRequest("analytics/browse/combined",t,e.proxy(function(t){typeof t.error=="undefined"&&this.updatePieAndTableChart(t.table);this.$infosDimension.html(this.$dimension.val());this.$infosMetric.html(this.$metric.val());var n=e(".btn.active",this.$tableType).data("tabletype");this.changeTableType(n);this.$spinner.addClass("hidden")},this))},updateAreaChart:function(t){this.chartAreaData=new google.visualization.DataTable;e.each(t.columns,e.proxy(function(e,t){var n=AnalyticsUtils.parseColumn(t);this.chartAreaData.addColumn(n.type,n.label)},this));this.chartAreaData.addRows(t.rows);this.chartArea||(this.chartArea=new google.visualization.AreaChart(this.$chart.get(0)));this.chartArea.draw(this.chartAreaData,this.areaChartOptions)},updateTotal:function(e){this.$counterValue.html(e.count);this.$counterLabel.html(e.label);this.$infosCount.html(e.count);this.$totalCount.html(e.count);this.$totalLabel.html(e.label)},updatePieAndTableChart:function(t){this.tableData=new google.visualization.DataTable;e.each(t.columns,e.proxy(function(e,t){var n=AnalyticsUtils.parseColumn(t);this.tableData.addColumn(n.type,n.label)},this));this.tableData.addRows(t.rows);this.chartTable||(this.chartTable=new google.visualization.Table(this.$table.get(0)));this.chartTable.draw(this.tableData,this.tableChartOptions);this.chartPie||(this.chartPie=new google.visualization.PieChart(this.$pie.get(0)));this.chartPie.draw(this.tableData,this.pieChartOptions)},resize:function(){this.chartArea&&this.chartArea.draw(this.chartAreaData,this.areaChartOptions);this.chartTable&&this.chartTable.draw(this.tableData,this.tableChartOptions);this.chartPie&&this.chartPie.draw(this.tableData,this.pieChartOptions)},onPeriodChange:function(t){this.currentPeriod=e(t.currentTarget).val();this.saveState();this.browse()},saveState:function(){var t=e(".btn.active",this.$tableType).data("tabletype"),n={id:this.$widget.data("widget-id"),menu:this.$menu.val(),dimension:this.$dimension.val(),metric:this.$metric.val(),chart:t,period:this.$periodSelect.val(),pinned:this.pinned};console.log("saveState",n);Craft.postActionRequest("analytics/browse/saveState",n,e.proxy(function(e){console.log("response",e)},this))},onMenuChange:function(t){$value=e(t.currentTarget).val();this.currentMenu=$value;this.currentNav=$value;this.changeMenu($value);this.browse();this.saveState()},changeMenu:function(t){this.currentNav=t;this.$dimension.html("");this.$metric.html("");this.setSection(t);if(this.sectionDimensions){this.$dimensionField.removeClass("hidden");e.each(this.sectionDimensions,e.proxy(function(t,n){e('<option value="'+n+'">'+n+"</option>").appendTo(this.$dimension)},this));var n=e("option:first",this.$dimension).attr("value");this.$dimension.val(n);console.log("val",this.$dimension.val())}else this.$dimensionField.addClass("hidden");this.sectionMetrics&&e.each(this.sectionMetrics,e.proxy(function(t,n){e('<option value="'+n+'">'+n+"</option>").appendTo(this.$metric)},this));if(this.sectionEnabledCharts){this.hideTableTypes();e.each(this.sectionEnabledCharts,e.proxy(function(e,t){this.showTableType(t)},this))}else{this.showTableTypes();this.hideTableType("counter");this.hideTableType("area")}if(this.sectionChart){this.$tableTypeBtns.removeClass("active");e('[data-tabletype="'+this.sectionChart+'"]',this.$tableType).addClass("active")}else{this.$tableTypeBtns.removeClass("active");e(".btn:first",this.$tableType).addClass("active")}console.log("this.sectionRealtime",this.sectionRealtime);if(this.sectionRealtime){this.$period.addClass("hidden");this.startRealtime()}else{this.$period.removeClass("hidden");this.stopRealtime()}},startRealtime:function(){console.log("start realtime");this.timer&&this.stopRealtime();this.timer=setInterval(e.proxy(function(){var e=this.requestData;e&&this.request(e)},this),4e3)},stopRealtime:function(){console.log("stop realtime",this.timer);clearInterval(this.timer)},showTableTypes:function(){e(".btn",this.$disabledTableType).appendTo(this.$tableType)},hideTableTypes:function(){e(".btn",this.$tableType).appendTo(this.$disabledTableType)},showTableType:function(t){e('[data-tabletype="'+t+'"]',this.$element).appendTo(this.$tableType)},hideTableType:function(t){e('[data-tabletype="'+t+'"]',this.$element).appendTo(this.$disabledTableType)},onTableTypeChange:function(t){var n=e(t.currentTarget).data("tabletype");this.changeTableType(n);this.saveState()},changeTableType:function(t){console.log("changeTableType",t);this.currentChart=t;this.$tableTypeBtns.removeClass("active");e('[data-tabletype="'+t+'"]',this.$tableType).addClass("active");if(t=="table"){this.$infosCount.addClass("hidden");this.$table.removeClass("hidden");this.$counter.addClass("hidden");this.$pie.addClass("hidden");this.$chart.addClass("hidden");if(this.sectionDimensions){this.$dimensionField.removeClass("hidden");this.$infosDimension.removeClass("hidden")}}else if(t=="area"){this.$infosDimension.removeClass("hidden");this.$infosCount.removeClass("hidden");this.$chart.removeClass("hidden");this.$table.addClass("hidden");this.$pie.addClass("hidden");this.$counter.addClass("hidden");this.$dimensionField.addClass("hidden")}else if(t=="counter"){this.$infosDimension.addClass("hidden");this.$infosCount.addClass("hidden");this.$chart.addClass("hidden");this.$table.addClass("hidden");this.$pie.addClass("hidden");this.$counter.removeClass("hidden");this.$dimensionField.addClass("hidden");this.$infosDimension.addClass("hidden")}else{this.$infosCount.addClass("hidden");this.$pie.removeClass("hidden");this.$chart.addClass("hidden");this.$table.addClass("hidden");this.$counter.addClass("hidden");if(this.sectionDimensions){this.$dimensionField.removeClass("hidden");this.$infosDimension.removeClass("hidden")}}this.resize()},onPin:function(){this.$pin.hasClass("active")?this.unpin():this.pin();this.saveState()},pin:function(){this.$pin.addClass("active");this.$collapsible.animate({opacity:0,height:"toggle"},200);this.pinned=1},unpin:function(){this.$pin.removeClass("active");this.$collapsible.animate({opacity:1,height:"toggle"},200);this.pinned=0},areaChartOptions:{theme:"maximized",legend:"none",backgroundColor:"#FFF",colors:["#058DC7"],areaOpacity:.1,pointSize:8,lineWidth:4,chartArea:{},hAxis:{textPosition:"in",textStyle:{color:"#058DC7"},showTextEvery:5,baselineColor:"#fff",gridlines:{color:"none"}},vAxis:{textPosition:"in",textStyle:{color:"#058DC7"},baselineColor:"#ccc",gridlines:{color:"#fafafa"},maxValue:0}},pieChartOptions:{theme:"maximized",pieHole:.5,legend:{alignment:"center",position:"top"},chartArea:{top:40,height:"82%"},sliceVisibilityThreshold:0},tableChartOptions:{page:"enable"}})})(jQuery);