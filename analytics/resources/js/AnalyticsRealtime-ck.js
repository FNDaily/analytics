AnalyticsRealtimeReport=Garnish.Base.extend({init:function(e){this._refresh=!1;this.$element=$("#"+e);this.$realtime=$(".analytics-realtime:first",this.$element);this.$progress=$(".analytics-progress:first",this.$realtime);this.$legend=$(".analytics-legend:first",this.$realtime);this.$errors=$(".analytics-errors:first",this.$realtime);this.$errorsInject=$(".analytics-errors-inject:first",this.$realtime);this.$body=$(".analytics-body:first",this.$realtime);this.$progressBlue=$(".progress-bar.blue:first",this.$realtime);this.$progressGreen=$(".progress-bar.green:first",this.$realtime);this.$content=$(".analytics-realtime-content:first",this.$realtime);this.$sources=$(".analytics-realtime-sources:first",this.$realtime);this.$countries=$(".analytics-realtime-countries:first",this.$realtime);this.$noVisitors=$(".no-active-visitors:first",this.$realtime);this.$count=$(".active-visitors .count:first",this.$realtime);this.$spinner=$(".spinner:first",this.$realtime);this.$spinner.removeClass("body-loading");this.start()},start:function(){this.request();var refreshInterval=eval(Analytics.realtimeRefreshInterval);refreshInterval==null?refreshInterval=10:refreshInterval<2&&(refreshInterval=100);refreshInterval*=1e3;this._refresh=setInterval($.proxy(function(){this.request()},this),refreshInterval)},stop:function(){clearInterval(this._refresh)},request:function(){console.log("request");this.$spinner.removeClass("hidden");Craft.postActionRequest("analytics/realtime",{},$.proxy(function(e){this.$errorsInject.html("");if(typeof e.error!="undefined"){this.$errors.removeClass("hidden");this.$body.addClass("hidden");$('<p class="error">'+e.error.message+"</p>").appendTo(this.$errorsInject)}else{this.$errors.addClass("hidden");this.$body.removeClass("hidden");this.updateProgress(e);this.updateTables(e)}this.$spinner.addClass("hidden")},this))},updateProgress:function(e){var t=e.visitorType.newVisitor,n=e.visitorType.returningVisitor,r=n*1+t*1;this.$count.text(r);if(r>0){this.$progress.removeClass("hidden");this.$legend.removeClass("hidden")}else{this.$progress.addClass("hidden");this.$legend.addClass("hidden")}if(r>0)var i=Math.round(100*t/r);else var i=100;var s=100-i;this.$progressBlue.css("width",i+"%");$("span",this.$progressBlue).text(i+"%");i>0?this.$progressBlue.removeClass("hidden"):this.$progressBlue.addClass("hidden");this.$progressGreen.css("width",s+"%");$("span",this.$progressGreen).text(s+"%");s>0?this.$progressGreen.removeClass("hidden"):this.$progressGreen.addClass("hidden")},updateTables:function(e){var t=e.visitorType.newVisitor,n=e.visitorType.returningVisitor,r=n*1+t*1;if(r>0){this.$noVisitors.addClass("hidden");$("table",this.$content).removeClass("hidden");$("tbody",this.$content).html("");$.each(e.content,function(e,t){var n=$("<tr><td>"+e+'</td><td class="thin">'+t+"</td></td>");$("tbody",this.$content).append(n)});$("table",this.$sources).removeClass("hidden");$("tbody",this.$sources).html("");$.each(e.sources,function(e,t){var n=$("<tr><td>"+e+'</td><td class="thin">'+t+"</td></td>");$("tbody",this.$sources).append(n)});$("table",this.$countries).removeClass("hidden");$("tbody",this.$countries).html("");$.each(e.countries,function(e,t){var n=$("<tr><td>"+e+'</td><td class="thin">'+t+"</td></td>");$("tbody",this.$countries).append(n)})}else{this.$noVisitors.removeClass("hidden");$("table",this.$content).addClass("hidden");$("table",this.$sources).addClass("hidden");$("table",this.$countries).addClass("hidden")}}});