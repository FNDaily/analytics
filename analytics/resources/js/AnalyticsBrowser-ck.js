google.load("visualization","1",{packages:["corechart","table","geochart"]});AnalyticsBrowser=Garnish.Base.extend({init:function(e){this.realtimeTimer=!1;this.requestData=!1;this.currentTableType="table";this.currentPeriod="month";this.chart=!1;this.chartData=!1;this.table=!1;this.tableData=!1;this.pie=!1;this.table=!1;this.$element=$("#"+e);this.$widget=$(".analytics-widget:first",this.$element);this.$browser=$(".analytics-browser:first",this.$widget);this.$browserHeader=$(".analytics-browser-header:first",this.$element);this.$chart=$(".analytics-chart",this.$browser).get(0);this.$pie=$(".analytics-piechart",this.$browser).get(0);this.$table=$(".analytics-table",this.$browser).get(0);this.$dimension=$(".analytics-dimension select",this.$browserHeader);this.$metric=$(".analytics-metric select",this.$browserHeader);this.$total=$(".analytics-total",this.$browser);this.$tableType=$(".analytics-tabletype:first",this.$browserHeader);this.$tableTypeBtns=$(".analytics-tabletype .btn",this.$browserHeader);this.$period=$(".analytics-period",this.$element);this.$periodSelect=$(".analytics-period select",this.$element);this.$spinner=$(".spinner",this.$browser);this.$pinBtn=$(".analytics-pin",this.$element);this.$spinner.removeClass("body-loading");this.addListener(this.$tableTypeBtns,"click",{},function(e){this.onTableTypeChange($(e.currentTarget).data("tabletype"))});this.$periodSelect.change($.proxy(function(e){this.onPeriodChange($(e.currentTarget).val());this.browse()},this));this.addListener(this.$pinBtn,"click",{},function(e){this.$pinBtn.hasClass("active")?this.unpin():this.pin()});this.changeCurrentNav("browserOs");this.$dimension.change($.proxy(function(){this.browse()},this));this.$metric.change($.proxy(function(){this.browse()},this));$(window).resize($.proxy(function(){this.resize()},this))},startRealtime:function(){console.log("start realtime");this.realtimeTimer=setInterval($.proxy(function(){var e=this.requestData;e&&this.runRequest(e)},this),1e4)},stopRealtime:function(){console.log("stop realtime");clearInterval(this.realtimeTimer)},pin:function(){this.$pinBtn.addClass("active");$(".analytics-collapsible",this.$element).animate({opacity:0,height:"toggle"},200,function(){})},unpin:function(){this.$pinBtn.removeClass("active");$(".analytics-collapsible",this.$element).animate({opacity:1,height:"toggle"},200,function(){})},resize:function(){this.chart&&this.chart.draw(this.chartData,this.chartOptions);this.table&&this.table.draw(this.tableData,this.tableOptions);this.pie&&this.pie.draw(this.tableData,this.pieOptions)},getSection:function(e){var t=!1;$.each(AnalyticsBrowserData,$.proxy(function(n,r){n==e&&(t=r)},this));return t},changeCurrentNav:function(e){this.$currentNav=e;this.$dimension.html("");this.$metric.html("");var t=this.getSection(e);if(t&&typeof t.dimensions!="undefined"&&t.dimensions.length>0){$(".analytics-dimension-field",this.$element).removeClass("hidden");$.each(t.dimensions,$.proxy(function(e,t){$('<option value="'+t+'">'+t+"</option>").appendTo(this.$dimension)},this))}else $(".analytics-dimension-field",this.$element).addClass("hidden");t&&typeof t.metrics!="undefined"&&$.each(t.metrics,$.proxy(function(e,t){$('<option value="'+t+'">'+t+"</option>").appendTo(this.$metric)},this));if(t&&typeof t.enabledCharts!="undefined"){this.hideTableTypes();$.each(t.enabledCharts,$.proxy(function(e,t){this.showTableType(t)},this))}else{this.showTableTypes();this.hideTableType("counter");this.hideTableType("area")}t&&typeof t.realtime!="undefined"?t.realtime?this.$period.addClass("hidden"):this.$period.addClass("hidden"):this.$period.removeClass("hidden");if(t&&typeof t.chart!="undefined"){this.$tableTypeBtns.removeClass("active");$('[data-tabletype="'+t.chart+'"]',this.$tableType).addClass("active")}else{this.$tableTypeBtns.removeClass("active");$(".analytics-tabletype .btn:first",this.$browserHeader).addClass("active")}t&&typeof t.realtime!="undefined"?t.realtime?this.startRealtime():this.stopRealtime():this.stopRealtime();this.browse()},showTableTypes:function(){$(".analytics-disabled-tabletype .btn",this.$browserHeader).appendTo($(".analytics-tabletype",this.$browserHeader))},hideTableTypes:function(){$(".analytics-tabletype .btn",this.$browserHeader).appendTo($(".analytics-disabled-tabletype",this.$browserHeader))},showTableType:function(e){$('[data-tabletype="'+e+'"]',this.$browserHeader).appendTo($(".analytics-tabletype",this.$browserHeader))},hideTableType:function(e){$('[data-tabletype="'+e+'"]',this.$browserHeader).appendTo($(".analytics-disabled-tabletype",this.$browserHeader))},onTableTypeChange:function(e){var t=this.getSection(this.$currentNav);this.currentTableType=e;this.$tableTypeBtns.removeClass("active");$('[data-tabletype="'+e+'"]',this.$tableType).addClass("active");if(e=="table"){$(".analytics-infos-count",this.$browser).addClass("hidden");$(".analytics-table",this.$browser).removeClass("hidden");$(".analytics-counter",this.$browser).addClass("hidden");$(".analytics-piechart",this.$browser).addClass("hidden");$(".analytics-chart",this.$browser).addClass("hidden");if(t&&typeof t.dimensions!="undefined"&&t.dimensions.length>0){$(".analytics-dimension-field",this.$browserHeader).removeClass("hidden");$(".analytics-infos-dimension",this.$browser).removeClass("hidden")}}else if(e=="area"){$(".analytics-infos-dimension",this.$browser).removeClass("hidden");$(".analytics-infos-count",this.$browser).removeClass("hidden");$(".analytics-chart",this.$browser).removeClass("hidden");$(".analytics-table",this.$browser).addClass("hidden");$(".analytics-piechart",this.$browser).addClass("hidden");$(".analytics-counter",this.$browser).addClass("hidden");$(".analytics-dimension-field",this.$browserHeader).addClass("hidden");$(".analytics-infos-dimension",this.$browser).addClass("hidden")}else if(e=="counter"){$(".analytics-infos-dimension",this.$browser).addClass("hidden");$(".analytics-infos-count",this.$browser).addClass("hidden");$(".analytics-chart",this.$browser).addClass("hidden");$(".analytics-table",this.$browser).addClass("hidden");$(".analytics-piechart",this.$browser).addClass("hidden");$(".analytics-counter",this.$browser).removeClass("hidden");$(".analytics-dimension-field",this.$browserHeader).addClass("hidden");$(".analytics-infos-dimension",this.$browser).addClass("hidden")}else{$(".analytics-infos-count",this.$browser).addClass("hidden");$(".analytics-piechart",this.$browser).removeClass("hidden");$(".analytics-chart",this.$browser).addClass("hidden");$(".analytics-table",this.$browser).addClass("hidden");$(".analytics-counter",this.$browser).addClass("hidden");if(t&&typeof t.dimensions!="undefined"&&t.dimensions.length>0){$(".analytics-dimension-field",this.$browserHeader).removeClass("hidden");$(".analytics-infos-dimension",this.$browser).removeClass("hidden")}}this.resize()},onPeriodChange:function(e){this.currentPeriod=e},browse:function(){var e={id:this.$widget.data("widget-id"),dimension:this.$dimension.val(),metric:this.$metric.val(),period:this.currentPeriod,realtime:0},t=this.getSection(this.$currentNav);t&&typeof t.realtime!="undefined"&&t.realtime&&(e.realtime=1);this.requestData=e;this.runRequest(e)},runRequest:function(e){this.$spinner.removeClass("hidden");console.log("run request");Craft.postActionRequest("analytics/browse/combined",e,$.proxy(function(e){if(typeof e.error=="undefined"){console.log(e);this.updateChart(e.chart);this.updateTable(e.table);this.updateTotal(e.total)}else console.log("error");$(".analytics-infos-dimension",this.$browser).html(this.$dimension.val());$(".analytics-infos-metric",this.$browser).html(this.$metric.val());this.onAfterBrowse();this.$spinner.addClass("hidden")},this))},onAfterBrowse:function(){var e=$(".analytics-tabletype .btn.active",this.$browserHeader).data("tabletype");this.onTableTypeChange(e)},updateChart:function(e){this.chartData=new google.visualization.DataTable;$.each(e.columns,$.proxy(function(e,t){var n=AnalyticsUtils.parseColumn(t);this.chartData.addColumn(n.type,n.label)},this));this.chartData.addRows(e.rows);this.chart||(this.chart=new google.visualization.AreaChart(this.$chart));this.chart.draw(this.chartData,this.chartOptions)},updateTotal:function(e){$(".analytics-counter-value",this.$element).html(e.count);$(".analytics-counter-label",this.$element).html(e.label);$(".analytics-infos-count",this.$element).html(e.count);$(".analytics-count",this.$total).html(e.count);$(".analytics-label",this.$total).html(e.label)},updateTable:function(e){this.tableData=new google.visualization.DataTable;$.each(e.columns,$.proxy(function(e,t){var n=AnalyticsUtils.parseColumn(t);this.tableData.addColumn(n.type,n.label)},this));this.tableData.addRows(e.rows);this.table||(this.table=new google.visualization.Table(this.$table));this.table.draw(this.tableData,this.tableOptions);this.pie||(this.pie=new google.visualization.PieChart(this.$pie));this.pie.draw(this.tableData,this.pieOptions)},chartOptions:{theme:"maximized",legend:"none",backgroundColor:"#FFF",colors:["#058DC7"],areaOpacity:.1,pointSize:8,lineWidth:4,chartArea:{},hAxis:{textPosition:"in",textStyle:{color:"#058DC7"},showTextEvery:5,baselineColor:"#fff",gridlines:{color:"none"}},vAxis:{textPosition:"in",textStyle:{color:"#058DC7"},baselineColor:"#ccc",gridlines:{color:"#fafafa"},maxValue:0}},pieOptions:{theme:"maximized",pieHole:.5,legend:{alignment:"center",position:"top"},chartArea:{top:40,height:"82%"},sliceVisibilityThreshold:0},tableOptions:{page:"enable"}});