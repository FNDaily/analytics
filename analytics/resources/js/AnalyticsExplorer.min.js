(function($){AnalyticsExplorer=Garnish.Base.extend({init:function(e,t){if(typeof google.visualization=="undefined"){typeof AnalyticsChartLanguage=="undefined"&&(AnalyticsChartLanguage="en");console.log("chartLanguage",AnalyticsChartLanguage);google.load("visualization","1",{packages:["corechart","table","geochart"],language:AnalyticsChartLanguage})}this.timer=!1;this.requestData=!1;this.currentMenu="audienceOverview";this.currentChart="area";this.currentMetric="ga:sessions";this.currentPeriod="month";this.pinned=0;this.chartArea=!1;this.chartGeo=!1;this.chartTable=!1;this.chartPie=!1;this.tableData=!1;this.chartAreaData=!1;this.$element=$("#"+e);this.$error=$(".analytics-error",this.$element);this.$menu=$(".analytics-menu:first select:first",this.$element);this.$widget=$(".analytics-widget:first",this.$element);this.$browser=$(".analytics-browser:first",this.$element);this.$chart=$(".analytics-chart",this.$element);this.$geo=$(".analytics-geo",this.$element);this.$pie=$(".analytics-piechart",this.$element);this.$table=$(".analytics-table",this.$element);this.$dimensionField=$(".analytics-dimension-field",this.$element);this.$dimension=$(".analytics-dimension select",this.$element);this.$metric=$(".analytics-metric select",this.$element);this.$total=$(".analytics-total",this.$element);this.$totalCount=$(".analytics-count",this.$total);this.$totalLabel=$(".analytics-label",this.$total);this.$tableType=$(".analytics-tabletype:first",this.$element);this.$disabledTableType=$(".analytics-disabled-tabletype:first",this.$element);this.$tableTypeBtns=$(".analytics-tabletype .btn",this.$element);this.$period=$(".analytics-period",this.$element);this.$periodSelect=$(".analytics-period select",this.$element);this.$spinner=$(".spinner",this.$element);this.$pin=$(".analytics-pin",this.$element);this.$infosDimension=$(".analytics-infos-dimension",this.$element);this.$infosMetric=$(".analytics-infos-metric",this.$element);this.$infosPeriod=$(".analytics-infos-period",this.$element);this.$infosCount=$(".analytics-infos-count",this.$element);this.$counter=$(".analytics-counter",this.$element);this.$counterValue=$(".analytics-counter-value",this.$element);this.$counterLabel=$(".analytics-counter-label",this.$element);this.$counterPeriod=$(".analytics-counter-period",this.$element);this.$collapsible=$(".analytics-collapsible",this.$element);this.addListener(this.$menu,"change","onMenuChange");this.addListener(this.$tableTypeBtns,"click","onTableTypeChange");this.addListener(this.$periodSelect,"change","onPeriodChange");this.addListener(this.$pin,"click","onPin");this.addListener(this.$dimension,"change","onChangeDimension");this.addListener(this.$metric,"change","onChangeMetric");this.addListener(Garnish.$win,"resize","resize");this.applySettings(t);this.$spinner.removeClass("body-loading");this.$periodSelect.val(this.currentPeriod);if(this.pinned){this.$pin.addClass("active");this.$collapsible.animate({opacity:0,height:"toggle"},0)}this.$menu.val(this.currentMenu);this.changeMenu(this.currentMenu);this.changeTableType(this.currentChart);this.$dimension.val(this.currentDimension);this.$metric.val(this.currentMetric);this.$period.val(this.currentPeriod);this.browse()},onChangeDimension:function(e){this.currentDimension=$(e.currentTarget).val();this.saveState();this.browse()},onChangeMetric:function(e){this.currentMetric=$(e.currentTarget).val();this.saveState();this.browse()},applySettings:function(settings){typeof settings.menu!="undefined"&&(this.currentMenu=settings.menu);typeof settings.dimension!="undefined"&&(this.currentDimension=settings.dimension);typeof settings.metric!="undefined"&&(this.currentMetric=settings.metric);typeof settings.chart!="undefined"&&(this.currentChart=settings.chart);typeof settings.period!="undefined"&&(this.currentPeriod=settings.period);typeof settings.pinned!="undefined"&&(this.pinned=eval(settings.pinned))},setSection:function(e){var t=!1;$.each(AnalyticsBrowserData,$.proxy(function(n,r){n==e&&(t=r)},this));this.sectionDimensions=!1;this.sectionMetrics=!1;this.sectionEnabledCharts=!1;this.sectionRealtime=!1;this.sectionChart=!1;if(t){typeof t.dimensions!="undefined"&&(this.sectionDimensions=t.dimensions);typeof t.metrics!="undefined"&&(this.sectionMetrics=t.metrics);typeof t.enabledCharts!="undefined"&&(this.sectionEnabledCharts=t.enabledCharts);typeof t.realtime!="undefined"&&(this.sectionRealtime=t.realtime);typeof t.chart!="undefined"&&(this.sectionChart=t.chart)}},browse:function(){var e={id:this.$widget.data("widget-id"),metric:this.$metric.val(),period:this.$periodSelect.val(),realtime:0};this.$dimensionField.hasClass("hidden")||(e.dimension=this.$dimension.val());this.sectionRealtime&&(e.realtime=1);this.requestData=e;this.request(e)},request:function(e){this.$spinner.removeClass("hidden");var t=$(".btn.active",this.$tableType).data("tabletype");Craft.postActionRequest("analytics/browse/"+t,e,$.proxy(function(e){if(typeof e.error=="undefined"){this.$browser.removeClass("hidden");this.$error.addClass("hidden");switch(t){case"area":this.updateAreaChart(e);break;case"geo":this.updateGeoChart(e);break;case"pie":this.updatePieAndTableChart(e);break;case"table":this.updatePieAndTableChart(e);break;case"counter":this.updateCounter(e)}if(typeof e.dimension!="undefined"){this.$infosDimension.removeClass("hidden");this.$infosDimension.html(e.dimension)}else this.$infosDimension.addClass("hidden");this.$infosMetric.html(e.metric);this.$infosPeriod.html(e.period);this.changeTableType(t)}else{this.$browser.addClass("hidden");this.$error.html(e.error);this.$error.removeClass("hidden")}this.$spinner.addClass("hidden")},this))},updateAreaChart:function(e){this.chartAreaData=new google.visualization.DataTable;$.each(e.area.columns,$.proxy(function(e,t){var n=AnalyticsUtils.parseColumn(t);this.chartAreaData.addColumn(n.type,n.label)},this));rows=e.area.rows;rows=AnalyticsUtils.parseRows(e.area.columns,e.area.rows);this.chartAreaData.addRows(rows);this.chartArea||(this.chartArea=new google.visualization.AreaChart(this.$chart.get(0)));if(this.$periodSelect.val()=="week"){this.areaChartOptions.hAxis.format="E";this.areaChartOptions.hAxis.showTextEvery=1}else if(this.$periodSelect.val()=="month"){this.areaChartOptions.hAxis.format="MMM d";this.areaChartOptions.hAxis.showTextEvery=1}else if(this.$periodSelect.val()=="year"){this.areaChartOptions.hAxis.showTextEvery=1;this.areaChartOptions.hAxis.format="MMM yy";var t=new google.visualization.DateFormat({pattern:"MMMM yyyy"});t.format(this.chartAreaData,0)}this.chartArea.draw(this.chartAreaData,this.areaChartOptions);this.$infosCount.html(e.total)},updateCounter:function(e){this.$counterValue.html(e.counter.count);this.$counterLabel.html(e.metric);this.$counterPeriod.html(e.period);this.$infosCount.html(e.counter.count);this.$totalCount.html(e.counter.count);this.$totalLabel.html(e.metric)},updateGeoChart:function(e){this.tableData=new google.visualization.DataTable;$.each(e.table.columns,$.proxy(function(e,t){var n=AnalyticsUtils.parseColumn(t);this.tableData.addColumn(n.type,n.label)},this));this.tableData.addRows(e.table.rows);this.chartGeo||(this.chartGeo=new google.visualization.GeoChart(this.$geo.get(0)));this.chartGeo.draw(this.tableData,this.pieChartOptions)},updatePieAndTableChart:function(e){this.tableData=new google.visualization.DataTable;$.each(e.table.columns,$.proxy(function(e,t){var n=AnalyticsUtils.parseColumn(t);this.tableData.addColumn(n.type,n.label)},this));this.tableData.addRows(e.table.rows);this.chartTable||(this.chartTable=new google.visualization.Table(this.$table.get(0)));this.chartTable.draw(this.tableData,this.tableChartOptions);this.chartPie||(this.chartPie=new google.visualization.PieChart(this.$pie.get(0)));this.chartPie.draw(this.tableData,this.pieChartOptions)},resize:function(){this.chartArea&&this.chartArea.draw(this.chartAreaData,this.areaChartOptions);this.chartTable&&this.chartTable.draw(this.tableData,this.tableChartOptions);this.chartPie&&this.chartPie.draw(this.tableData,this.pieChartOptions);var e=0;$.each($(".analytics-toolbar select, .analytics-toolbar .btngroup",this.$element),function(){e+=$(this).width()+20});e<this.$widget.width()?this.$widget.removeClass("analytics-small"):this.$widget.addClass("analytics-small")},onPeriodChange:function(e){this.currentPeriod=$(e.currentTarget).val();this.saveState();this.browse()},saveState:function(){var e=$(".btn.active",this.$tableType).data("tabletype"),t={id:this.$widget.data("widget-id"),menu:this.$menu.val(),dimension:this.$dimension.val(),metric:this.$metric.val(),chart:e,period:this.$periodSelect.val(),pinned:this.pinned};Craft.postActionRequest("analytics/browse/saveState",t,$.proxy(function(e){},this))},onMenuChange:function(e){$value=$(e.currentTarget).val();this.currentMenu=$value;this.currentNav=$value;this.changeMenu($value);this.browse();this.saveState()},changeMenu:function(e){this.currentNav=e;this.$dimension.html("");this.$metric.html("");this.setSection(e);if(this.sectionDimensions){this.$dimensionField.removeClass("hidden");$.each(this.sectionDimensions,$.proxy(function(e,t){$('<option value="'+t.value+'">'+t.label+"</option>").appendTo(this.$dimension)},this));var t=$("option:first",this.$dimension).attr("value");this.$dimension.val(t)}else this.$dimensionField.addClass("hidden");this.sectionMetrics&&$.each(this.sectionMetrics,$.proxy(function(e,t){$('<option value="'+t.value+'">'+t.label+"</option>").appendTo(this.$metric)},this));if(this.sectionEnabledCharts){this.hideTableTypes();$.each(this.sectionEnabledCharts,$.proxy(function(e,t){this.showTableType(t)},this))}else{this.showTableTypes();this.hideTableType("geo");this.hideTableType("counter");this.hideTableType("area")}if(this.sectionChart){this.$tableTypeBtns.removeClass("active");$('[data-tabletype="'+this.sectionChart+'"]',this.$tableType).addClass("active")}else{this.$tableTypeBtns.removeClass("active");$(".btn:first",this.$tableType).addClass("active")}if(this.sectionRealtime){this.$period.addClass("hidden");this.startRealtime()}else{this.$period.removeClass("hidden");this.stopRealtime()}},startRealtime:function(){this.timer&&this.stopRealtime();this.timer=setInterval($.proxy(function(){var e=this.requestData;e&&this.request(e)},this),4e3)},stopRealtime:function(){clearInterval(this.timer)},showTableTypes:function(){$(".btn",this.$disabledTableType).appendTo(this.$tableType)},hideTableTypes:function(){$(".btn",this.$tableType).appendTo(this.$disabledTableType)},showTableType:function(e){$('[data-tabletype="'+e+'"]',this.$element).appendTo(this.$tableType)},hideTableType:function(e){$('[data-tabletype="'+e+'"]',this.$element).appendTo(this.$disabledTableType)},onTableTypeChange:function(e){var t=$(e.currentTarget).data("tabletype");this.$tableTypeBtns.removeClass("active");$('[data-tabletype="'+t+'"]',this.$tableType).addClass("active");this.saveState();this.browse()},changeTableType:function(e){this.currentChart=e;this.$tableTypeBtns.removeClass("active");$('[data-tabletype="'+e+'"]',this.$tableType).addClass("active");if(e=="table"){this.$infosCount.addClass("hidden");this.$table.removeClass("hidden");this.$counter.addClass("hidden");this.$pie.addClass("hidden");this.$chart.addClass("hidden");this.$geo.addClass("hidden");if(this.sectionDimensions){this.$dimensionField.removeClass("hidden");this.$infosDimension.removeClass("hidden")}}else if(e=="area"){this.$infosCount.removeClass("hidden");this.$chart.removeClass("hidden");this.$table.addClass("hidden");this.$pie.addClass("hidden");this.$counter.addClass("hidden");this.$dimensionField.addClass("hidden");this.$geo.addClass("hidden")}else if(e=="geo"){this.$infosCount.addClass("hidden");this.$pie.addClass("hidden");this.$chart.addClass("hidden");this.$table.addClass("hidden");this.$counter.addClass("hidden");this.$geo.removeClass("hidden")}else if(e=="counter"){this.$infosDimension.addClass("hidden");this.$infosCount.addClass("hidden");this.$chart.addClass("hidden");this.$table.addClass("hidden");this.$pie.addClass("hidden");this.$counter.removeClass("hidden");this.$dimensionField.addClass("hidden");this.$infosDimension.addClass("hidden");this.$geo.addClass("hidden")}else{this.$infosCount.addClass("hidden");this.$pie.removeClass("hidden");this.$chart.addClass("hidden");this.$table.addClass("hidden");this.$counter.addClass("hidden");this.$geo.addClass("hidden");if(this.sectionDimensions){this.$dimensionField.removeClass("hidden");this.$infosDimension.removeClass("hidden")}}this.resize()},onPin:function(){this.$pin.hasClass("active")?this.unpin():this.pin();this.saveState()},pin:function(){this.$pin.addClass("active");this.$collapsible.animate({opacity:0,height:"toggle"},200);this.pinned=1},unpin:function(){this.$pin.removeClass("active");this.$collapsible.animate({opacity:1,height:"toggle"},200);this.pinned=0},areaChartOptions:{theme:"maximized",legend:"none",backgroundColor:"#FFF",colors:["#058DC7"],areaOpacity:.1,pointSize:8,lineWidth:4,chartArea:{},hAxis:{format:"E",textPosition:"in",textStyle:{color:"#058DC7"},showTextEvery:1,baselineColor:"#fff",gridlines:{color:"none"}},vAxis:{textPosition:"in",textStyle:{color:"#058DC7"},baselineColor:"#ccc",gridlines:{color:"#fafafa"},maxValue:0}},pieChartOptions:{theme:"maximized",pieHole:.5,legend:{alignment:"center",position:"top"},chartArea:{top:40,height:"82%"},sliceVisibilityThreshold:1/120},tableChartOptions:{page:"enable"}})})(jQuery);