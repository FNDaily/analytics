(function(e){typeof Analytics=="undefined"&&(Analytics={});var t=!1;Analytics.Explorer=Garnish.Base.extend({init:function(n,r){console.log("Explorer");this.$element=e("#"+n);this.$widget=e(".analytics-widget:first",this.$element);this.$views=e(".analytics-view",this.$element);this.view=!1;this.section=!1;if(t==0){typeof AnalyticsChartLanguage=="undefined"&&(AnalyticsChartLanguage="en");google.load("visualization","1",{packages:["corechart","table","geochart"],language:AnalyticsChartLanguage});t=!0}google.setOnLoadCallback(e.proxy(function(){if(typeof google.visualization=="undefined"){this.$widget.addClass("hidden");this.$error.html("An unknown error occured");this.$error.removeClass("hidden");return}this.initActions();this.initMenu()},this))},initMenu:function(){console.log("initMenu");this.$menu=e(".analytics-menu:first select:first",this.$element);this.menu=new Analytics.Menu(this.$menu,{onMenuChange:e.proxy(function(t,n){this.view&&this.view.destroy();this.$views.addClass("hidden");section=this.getSection(t);switch(section.view){case"realtimeVisitors":this.view=new Analytics.RealtimeVisitorsView(this,this.$element);break;case"browser":this.view=new Analytics.BrowserView(this,this.$element,section)}e('[data-view="'+section.view+'"]',this.$element).removeClass("hidden");this.section=section;n&&this.saveState()},this)})},saveState:function(){this.view.saveState()},initActions:function(){$pinBtn=e(".analytics-pin",this.$element);$collapsible=e(".analytics-collapsible",this.$element);this.pinBtn=new Analytics.PinBtn($pinBtn,$collapsible,{onPinChange:e.proxy(function(){this.saveState()},this)})},getSection:function(t){var n={uri:!1,view:!1,dimensions:!1,metrics:!1,enabledCharts:!1,realtime:!1,chart:!1},r=null;e.each(AnalyticsBrowserData,e.proxy(function(e,n){e==t&&(r=n)},this));if(r){typeof r.dimensions!="undefined"&&(n.dimensions=r.dimensions);typeof r.metrics!="undefined"&&(n.metrics=r.metrics);typeof r.enabledCharts!="undefined"&&(n.enabledCharts=r.enabledCharts);typeof r.realtime!="undefined"&&(n.realtime=r.realtime);typeof r.chart!="undefined"&&(n.chart=r.chart);typeof r.uri!="undefined"&&(n.uri=r.uri);typeof r.view!="undefined"&&(n.view=r.view)}return n}});Analytics.Menu=Garnish.Base.extend({init:function(e,t){this.$menu=e;this.settings=t;this.section=!1;this.defaultMenu="audienceOverview";this.currentMenu=!1;this.addListener(this.$menu,"change","onMenuChange");this.changeMenu(this.defaultMenu,!1)},val:function(){return this.currentMenu},onMenuChange:function(t){value=e(t.currentTarget).val();this.currentMenu=value;this.changeMenu(value)},changeMenu:function(e,t){typeof t=="undefined"&&(t=!0);this.currentMenu=e;this.$menu.val(e);this.settings.onMenuChange(this.currentMenu,t)}});Analytics.PinBtn=Garnish.Base.extend({init:function(e,t,n){this.$pinBtn=e;this.$collapsible=t;this.settings=n;this.pinned=0;this.addListener(this.$pinBtn,"click","onPin")},val:function(){return this.pinned},onPin:function(){this.$pinBtn.hasClass("active")?this.unpin():this.pin()},pin:function(){this.$pinBtn.addClass("active");this.$collapsible.addClass("analytics-collapsed");this.pinned=1;this.$collapsible.transition({height:"0px"},200,"ease-out");this.settings.onPinChange()},unpin:function(){this.$pinBtn.removeClass("active");this.$collapsible.removeClass("analytics-collapsed");this.pinned=0;this.$collapsible.transition({height:"auto"},200,"ease-out");this.settings.onPinChange()}});Analytics.BrowserView=Garnish.Base.extend({init:function(t,n,r){console.log("BrowserView");this.$element=n;this.$menu=e(".analytics-menu:first select:first",this.$element);this.$metricsField=e(".analytics-metric-field",this.$element);this.$dimensionsField=e(".analytics-dimension-field",this.$element);this.$tableTypes=e(".analytics-tabletypes:first",this.$element);this.$periodField=e(".analytics-period",this.$element);this.explorer=t;this.browser=!1;this.section=r;this.metrics=new Analytics.MetricsField(this.$metricsField,r.metrics,{onChange:e.proxy(this,"onMetricsChange")});this.dimensions=new Analytics.DimensionsField(this.$dimensionsField,r.dimensions,{onChange:e.proxy(this,"onDimensionsChange")});this.tableTypes=new Analytics.TableTypes(this.$tableTypes,{enabledCharts:r.enabledCharts,defaultChart:r.chart,onChange:e.proxy(this,"onTableTypesChange")});this.period=new Analytics.PeriodField(this.$periodField,{onChange:e.proxy(this,"onPeriodChange")});this.browse()},saveState:function(t){var n={id:this.explorer.$widget.data("widget-id"),settings:{menu:this.explorer.menu.val(),pinned:this.explorer.pinBtn.val(),metric:this.metrics.val(),dimension:this.dimensions.val(),chart:this.tableTypes.val(),period:this.period.val()}};console.log("save state",n);Craft.queueActionRequest("analytics/explorer/saveWidgetState",n,e.proxy(function(e){},this))},destroy:function(){this.metrics.destroy();this.dimensions.destroy();this.tableTypes.destroy();this.period.destroy();if(this.browser){this.browser.destroy();this.browser=!1}},onMetricsChange:function(t){value=e(t.currentTarget).val();this.browse();this.saveState()},onDimensionsChange:function(t){value=e(t.currentTarget).val();this.browse();this.saveState()},onTableTypesChange:function(e){this.browse();this.saveState()},onPeriodChange:function(t){value=e(t.currentTarget).val();this.browse();this.saveState()},browse:function(){console.log("browse");if(this.browser){this.browser.destroy();this.browser=!1}data={metrics:this.metrics.val(),dimensions:this.dimensions.val(),tableType:this.tableTypes.val(),period:this.period.val(),realtime:0};typeof this.section.realtime!="undefined"&&this.section.realtime&&(data.realtime=1);this.browser=new Analytics.Browser(this.$element,data)}});Analytics.Browser=Garnish.Base.extend({init:function(t,n){console.log("init AnalyticsBrowser");this.$element=t;this.$spinner=e(".spinner",this.$element);this.$error=e(".analytics-error",this.$element);this.$browser=e(".analytics-browser:first",this.$element);this.$browserContent=e(".analytics-browser-content:first",this.$element);this.$widget=e(".analytics-widget:first",this.$element);this.$infos=e(".analytics-infos",this.$element);this.$infosDimension=e(".analytics-infos-dimension",this.$element);this.$infosMetric=e(".analytics-infos-metric",this.$element);this.$infosPeriod=e(".analytics-infos-period",this.$element);this.$infosCount=e(".analytics-infos-count",this.$element);this.$chart=e(".analytics-single-chart",this.$element);this.$counter=e(".analytics-counter",this.$element);this.$counterValue=e(".analytics-counter-value",this.$element);this.$counterLabel=e(".analytics-counter-label",this.$element);this.$counterPeriod=e(".analytics-counter-period",this.$element);this.timer=!1;this.data=n;this.addListener(Garnish.$win,"resize","resize");this.request();this.data.realtime&&this.startRealtime()},destroy:function(){this.removeListener(Garnish.$win,"resize");this.stopRealtime()},startRealtime:function(){this.timer&&this.stopRealtime();this.timer=setInterval(e.proxy(function(){this.request()},this),AnalyticsRealtimeInterval*1e3)},stopRealtime:function(){clearInterval(this.timer)},request:function(){console.log("request",this.data);var t=this.data.tableType;this.$spinner.removeClass("body-loading");this.$spinner.removeClass("hidden");Craft.queueActionRequest("analytics/explorer/"+t,this.data,e.proxy(function(e,n){if(n=="success"&&typeof e.error=="undefined"){this.$browserContent.removeClass("hidden");this.$error.addClass("hidden");this.handleResponse(e,t)}else{this.$browserContent.addClass("hidden");this.$error.html(e.error);this.$error.removeClass("hidden")}this.$chart.removeClass("analytics-chart-area");this.$chart.removeClass("analytics-chart-table");this.$chart.removeClass("analytics-chart-pie");this.$chart.removeClass("analytics-chart-counter");this.$chart.removeClass("analytics-chart-geo");this.$chart.addClass("analytics-chart-"+t);this.$spinner.addClass("hidden")},this))},handleResponse:function(e,t){switch(t){case"area":this.handleAreaChartResponse(e);break;case"geo":this.handleGeoChartResponse(e);break;case"pie":this.handlePieChartResponse(e);break;case"table":this.handleTableChartResponse(e);break;case"counter":this.handleCounterResponse(e)}if(typeof e.dimension!="undefined"){this.$infosDimension.removeClass("hidden");this.$infosDimension.html(e.dimension)}else this.$infosDimension.addClass("hidden");if(typeof e.metric!="undefined"){this.$infosMetric.removeClass("hidden");this.$infosMetric.html(e.metric)}else this.$infosMetric.addClass("hidden");if(typeof e.total!="undefined"){this.$infosCount.html(e.total);this.$infosCount.removeClass("hidden")}else this.$infosCount.addClass("hidden");this.$infosPeriod.html(e.period);if(t=="counter"){this.$counter.removeClass("hidden");this.$chart.addClass("hidden");this.$infos.addClass("hidden")}else{this.$counter.addClass("hidden");this.$chart.removeClass("hidden");this.$infos.removeClass("hidden")}this.resize()},fillChartData:function(t){this.chartData=new google.visualization.DataTable;e.each(t.columns,e.proxy(function(e,t){var n=AnalyticsUtils.parseColumn(t);this.chartData.addColumn(n.type,n.label)},this));rows=t.rows;rows=AnalyticsUtils.parseRows(t.columns,t.rows);this.chartData.addRows(rows)},handleAreaChartResponse:function(t){this.fillChartData(t.area);this.chartOptions=Analytics.ChartOptions.area;console.log("chartOptions",this.chartOptions);if(this.data.period=="week"){this.chartOptions.hAxis.format="E";this.chartOptions.hAxis.showTextEvery=1}else if(this.data.period=="month"){this.chartOptions.hAxis.format="MMM d";this.chartOptions.hAxis.showTextEvery=1}else if(this.data.period=="year"){this.chartOptions.hAxis.showTextEvery=1;this.chartOptions.hAxis.format="MMM yy";var n=new google.visualization.DateFormat({pattern:"MMMM yyyy"});n.format(this.chartData,0)}var r=e("<div>");this.chart=new google.visualization.AreaChart(r.get(0));this.$chart.html("");this.$chart.append(r);this.chart.draw(this.chartData,this.chartOptions)},handleCounterResponse:function(e){this.$counterValue.html(e.counter.count);this.$counterLabel.html(e.metric);this.$counterPeriod.html(e.period)},handleGeoChartResponse:function(t){this.fillChartData(t.table);this.chartOptions=Analytics.ChartOptions.geo;var n=e("<div>");this.chart=new google.visualization.GeoChart(n.get(0));this.$chart.html("");this.$chart.append(n);this.chart.draw(this.chartData,this.chartOptions)},handleTableChartResponse:function(t){this.fillChartData(t.table);this.chartOptions=Analytics.ChartOptions.table;var n=e("<div>");this.chart=new google.visualization.Table(n.get(0));this.$chart.html("");this.$chart.append(n);this.chart.draw(this.chartData,this.chartOptions)},handlePieChartResponse:function(t){this.fillChartData(t.table);this.chartOptions=Analytics.ChartOptions.pie;var n=e("<div>");this.chart=new google.visualization.PieChart(n.get(0));this.$chart.html("");this.$chart.append(n);this.chart.draw(this.chartData,this.chartOptions)},resize:function(){console.log("Analytics.Browser.resize()");this.chart&&this.chart.draw(this.chartData,this.chartOptions);var t=0;e.each(e(".analytics-toolbar select, .analytics-toolbar .btngroup",this.$element),function(){t+=e(this).width()+20});t<this.$widget.width()?this.$widget.removeClass("analytics-small"):this.$widget.addClass("analytics-small")}});Analytics.PeriodField=Garnish.Base.extend({init:function(t,n){this.$field=t;this.$select=e("select",this.$field);this.settings=n;this.addListener(this.$select,"change","onChange")},val:function(){return this.$select.val()},destroy:function(){this.removeListener(this.$select,"change")},onChange:function(e){this.settings.onChange(e)}});Analytics.DimensionsField=Garnish.Base.extend({init:function(t,n,r){this.$field=t;this.$dimension=e("select",this.$field);this.settings=r;this.addListener(this.$dimension,"change","onChange");this.$dimension.html("");if(n){this.$field.removeClass("hidden");e.each(n,e.proxy(function(t,n){e('<option value="'+n.value+'">'+n.label+"</option>").appendTo(this.$dimension)},this));var i=e("option:first",this.$dimension).attr("value");this.$dimension.val(i)}else this.$field.addClass("hidden")},val:function(){return this.$dimension.val()},destroy:function(){this.removeListener(this.$dimension,"change")},onChange:function(e){this.settings.onChange(e)}});Analytics.MetricsField=Garnish.Base.extend({init:function(t,n,r){this.$field=t;this.$metric=e("select",this.$field);this.settings=r;this.addListener(this.$metric,"change","onChange");this.$metric.html("");if(n){this.$field.removeClass("hidden");e.each(n,e.proxy(function(t,n){e('<option value="'+n.value+'">'+n.label+"</option>").appendTo(this.$metric)},this))}else this.$field.addClass("hidden")},val:function(){return this.$metric.val()},destroy:function(){this.removeListener(this.$metric,"change")},onChange:function(e){this.settings.onChange(e)}});Analytics.TableTypes=Garnish.Base.extend({init:function(t,n){this.$tableTypes=t;this.$enabledTableTypes=e(".analytics-enabled-tabletypes:first",this.$tableTypes);this.$disabledTableTypes=e(".analytics-disabled-tabletypes:first",this.$tableTypes);this.$tableTypeBtns=e(".btn",this.$tableTypes);this.settings=n;this.value=!1;this.addListener(this.$tableTypeBtns,"click","onTableTypeChange");this.$tableTypeBtns.removeClass("active");if(n.enabledCharts){this.hideTableTypes();e.each(n.enabledCharts,e.proxy(function(e,t){this.showTableType(t)},this))}else{this.showTableTypes();this.hideTableType("geo");this.hideTableType("counter");this.hideTableType("area")}n.defaultChart?e('[data-tabletype="'+n.defaultChart+'"]',this.$enabledTableTypes).addClass("active"):e(".btn:first",this.$enabledTableTypes).addClass("active");this.value=e(".btn.active:first",this.$tableTypes).data("tabletype")},val:function(){return this.value},destroy:function(){this.removeListener(this.$tableTypeBtns,"click")},showTableTypes:function(){e(".btn",this.$disabledTableTypes).appendTo(this.$enabledTableTypes)},hideTableTypes:function(){e(".btn",this.$enabledTableTypes).appendTo(this.$disabledTableTypes)},showTableType:function(t){e('[data-tabletype="'+t+'"]',this.$tableTypes).appendTo(this.$enabledTableTypes)},hideTableType:function(t){e('[data-tabletype="'+t+'"]',this.$tableTypes).appendTo(this.$disabledTableTypes)},onTableTypeChange:function(t){var n=e(t.currentTarget).data("tabletype");this.$tableTypeBtns.removeClass("active");e('[data-tabletype="'+n+'"]',this.$enabledTableTypes).addClass("active");this.value=n;this.settings.onChange(this.value)}});Analytics.RealtimeVisitorsView=Garnish.Base.extend({init:function(e,t){this.$element=t;this.explorer=e;console.log("hello real time visitors view");this.realtimeVisitors=new Analytics.RealtimeVisitors(this.$element)},saveState:function(){var t={id:this.explorer.$widget.data("widget-id"),settings:{menu:this.explorer.menu.val(),pinned:this.explorer.pinBtn.val()}};console.log("save state",t);Craft.queueActionRequest("analytics/explorer/saveWidgetState",t,e.proxy(function(e){},this))},destroy:function(){this.realtimeVisitors.destroy()}});Analytics.RealtimeVisitors=Garnish.Base.extend({init:function(t){this.$element=t;this.$realtimeVisitors=e(".analytics-realtime-visitors",this.$element);this.$error=e(".analytics-error",this.$element);this.$spinner=e(".spinner",this.$element);this.timer=!1;this.request();this.startRealtime()},destroy:function(){this.stopRealtime()},startRealtime:function(){this.timer&&this.stopRealtime();this.timer=setInterval(e.proxy(function(){this.request()},this),AnalyticsRealtimeInterval*1e3)},stopRealtime:function(){clearInterval(this.timer)},request:function(){this.$spinner.removeClass("body-loading");this.$spinner.removeClass("hidden");Craft.queueActionRequest("analytics/explorer/realtimeVisitors",{},e.proxy(function(e,t){if(t=="success"&&typeof e.error=="undefined"){this.$realtimeVisitors.removeClass("hidden");this.$error.addClass("hidden");this.handleResponse(e)}else{msg="An unknown error occured.";typeof e!="undefined"&&e&&typeof e.error!="undefined"&&(msg=e.error);this.$realtimeVisitors.addClass("hidden");this.$error.html(msg);this.$error.removeClass("hidden")}this.$spinner.addClass("hidden")},this))},handleResponse:function(t){var n=t.newVisitor,r=t.returningVisitor,i=r*1+n*1;e(".active-visitors .count",this.$realtimeVisitors).text(i);if(i>0){e(".progress",this.$realtimeVisitors).removeClass("hidden");e(".legend",this.$realtimeVisitors).removeClass("hidden")}else{e(".progress",this.$realtimeVisitors).addClass("hidden");e(".legend",this.$realtimeVisitors).addClass("hidden")}if(i>0)var s=Math.round(100*n/i);else var s=100;var o=100-s;e(".progress-bar.blue",this.$realtimeVisitors).css("width",s+"%");e(".progress-bar.blue span",this.$realtimeVisitors).text(s+"%");s>0?e(".progress-bar.blue",this.$realtimeVisitors).removeClass("hidden"):e(".progress-bar.blue",this.$realtimeVisitors).addClass("hidden");e(".progress-bar.green",this.$realtimeVisitors).css("width",o+"%");e(".progress-bar.green span",this.$realtimeVisitors).text(o+"%");o>0?e(".progress-bar.green",this.$realtimeVisitors).removeClass("hidden"):e(".progress-bar.green",this.$realtimeVisitors).addClass("hidden")}});Analytics.ChartOptions=Garnish.Base.extend({},{area:{height:150,theme:"maximized",legend:"none",backgroundColor:"#FFF",colors:["#058DC7"],areaOpacity:.1,pointSize:8,lineWidth:4,chartArea:{},hAxis:{format:"E",textPosition:"in",textStyle:{color:"#058DC7"},showTextEvery:1,baselineColor:"#fff",gridlines:{color:"none"}},vAxis:{textPosition:"in",textStyle:{color:"#058DC7"},baselineColor:"#ccc",gridlines:{color:"#fafafa"},maxValue:0}},geo:{height:282},pie:{theme:"maximized",height:282,pieHole:.5,legend:{alignment:"center",position:"top"},chartArea:{top:40,height:"82%"},sliceVisibilityThreshold:1/120},table:{page:"enable"}})})(jQuery);